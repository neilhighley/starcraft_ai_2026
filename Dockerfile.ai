FROM python:3.10-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    wget \
    netcat-openbsd \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip install --upgrade pip setuptools wheel

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional monitoring dependencies
RUN pip install --no-cache-dir \
    prometheus-client==0.19.0 \
    prometheus-fastapi-instrumentator==6.1.0 \
    fastapi==0.109.0 \
    uvicorn[standard]==0.27.0 \
    pydantic==2.5.3 \
    redis==5.0.1 \
    python-multipart==0.0.6

# Create necessary directories
RUN mkdir -p /app/logs /app/ai_agent /app/monitoring

# Copy AI agent code
COPY ai_agent/ ./ai_agent/
COPY monitoring/ ./monitoring/

# Create non-root user for security
RUN useradd -m -u 1000 sc2ai && \
    chown -R sc2ai:sc2ai /app
USER sc2ai

# Expose ports
EXPOSE 8080 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Default command
CMD ["python", "ai_agent/main.py"]
